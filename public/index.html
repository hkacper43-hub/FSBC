<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>FSBC Mapa - System Wieloosobowy</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { 
            --bg: #0f111a; 
            --sidebar: #1a1c24; 
            --accent: #ff4757; 
            --occupied: #2ecc71;
        }

        body { 
            margin: 0; padding: 10px; display: flex; height: 100vh; 
            background: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            color: white; overflow: hidden; box-sizing: border-box; gap: 10px; 
        }
        
        #sidebar { 
            width: 320px; background: var(--sidebar); display: flex; 
            flex-direction: column; padding: 20px; border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 2000;
        }
        
        #map { 
            flex-grow: 1; background: #000; border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .btn-discord { 
            background: #5865F2; color: white; border: none; 
            padding: 12px; border-radius: 10px; cursor: pointer; 
            font-weight: bold; width: 100%; transition: 0.3s;
            text-align: center; display: block; text-decoration: none;
        }

        .user-card { 
            display: flex; align-items: center; gap: 10px; 
            background: rgba(255,255,255,0.05); padding: 12px; 
            border-radius: 10px; margin-bottom: 10px;
        }

        #drawBtn { 
            width: 100%; padding: 12px; margin-top: 10px; 
            cursor: pointer; font-weight: bold; border-radius: 8px; 
            border: none; background: #eee; color: black; transition: 0.3s;
        }

        #drawBtn.active { background: var(--accent); color: white; }

        /* Styl etykiet z awatarami na mapie */
        .leaflet-tooltip.zone-label { 
            background: transparent; border: none; 
            box-shadow: none; padding: 0; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="margin-top: 0;">FSBC LOBBY</h2>
    
    <div id="auth-section">
        <a href="/auth/discord" class="btn-discord">ZALOGUJ PRZEZ DISCORD</a>
    </div>

    <div id="profile-section" style="display:none;">
        <div class="user-card">
            <img id="user-avatar" src="" style="width:40px; border-radius:50%;">
            <div>
                <b id="user-name"></b><br>
                <small id="user-status" style="color:var(--occupied); font-weight: bold;"></small>
            </div>
        </div>
        
        <div id="admin-tools" style="display:none; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
            <p style="color:var(--accent); margin:0 0 10px 0; font-size:11px; font-weight:bold; text-transform: uppercase;">Moderacja</p>
            <button onclick="toggleDrawMode()" id="drawBtn">Dodaj Strefę</button>
        </div>
        <a href="/logout" style="color: #888; font-size: 12px; margin-top: 15px; display: inline-block;">Wyloguj się</a>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let currentUser = null;
    let isDrawMode = false;
    let firstPoint = null;
    let savedZones = [];

    // Konfiguracja Mapy
    const map = L.map('map', { 
        crs: L.CRS.Simple, 
        minZoom: -0.5, maxZoom: 0.5, zoom: 0,
        dragging: true, zoomControl: false, attributionControl: false 
    });

    const bounds = [[0, 0], [590, 670]];
    L.imageOverlay('https://cdn.discordapp.com/attachments/1444651629633601669/1459626248463450163/image.png?ex=69674220&is=6965f0a0&hm=b0ae409d4a765278ae114ac8b48ba4b03c441303a367628e57b8c4aaff1aa096&', bounds).addTo(map);
    map.fitBounds(bounds);

    async function init() {
        try {
            const res = await fetch('/api/user');
            currentUser = await res.json();
            
            if (currentUser) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('profile-section').style.display = 'block';
                document.getElementById('user-name').innerText = currentUser.username;
                document.getElementById('user-avatar').src = `https://cdn.discordapp.com/avatars/${currentUser.id}/${currentUser.avatar}.png`;
                document.getElementById('user-status').innerText = currentUser.isAdmin ? "Moderator" : "Gracz";
                
                if (currentUser.isAdmin) {
                    document.getElementById('admin-tools').style.display = 'block';
                }
            }
        } catch(e) { console.error("Auth error"); }

        loadZones();
    }

    async function loadZones() {
        const res = await fetch('/api/zones');
        savedZones = await res.json();
        savedZones.forEach(zoneData => renderZone(zoneData));
    }

    function toggleDrawMode() {
        isDrawMode = !isDrawMode;
        const btn = document.getElementById('drawBtn');
        btn.innerText = isDrawMode ? 'KLIKNIJ 2 PUNKTY' : 'Dodaj Strefę';
        btn.className = isDrawMode ? 'active' : '';
    }

    map.on('click', function(e) {
        if (currentUser && currentUser.isAdmin && isDrawMode) {
            if (!firstPoint) {
                firstPoint = e.latlng;
            } else {
                const newZone = {
                    id: Date.now(),
                    p1: firstPoint,
                    p2: e.latlng,
                    color: '#ff4757',
                    owners: []
                };
                savedZones.push(newZone);
                renderZone(newZone);
                saveZonesToServer();
                
                firstPoint = null;
                toggleDrawMode();
            }
        }
    });

    function renderZone(zoneData) {
        // Konwersja starych danych na nowy system wielu osób
        if (!zoneData.owners) zoneData.owners = [];
        if (zoneData.owner && zoneData.owners.length === 0) {
            zoneData.owners.push({ name: zoneData.owner, avatar: zoneData.ownerAvatar });
            delete zoneData.owner;
        }

        const isOccupied = zoneData.owners.length > 0;
        const currentColor = isOccupied ? '#2ecc71' : zoneData.color;

        const zone = L.rectangle([zoneData.p1, zoneData.p2], { 
            color: currentColor, 
            weight: 2, 
            fillOpacity: isOccupied ? 0.4 : 0.2, 
            interactive: true 
        }).addTo(map);

        // Wyświetlanie etykiety z awatarami
        if (isOccupied) {
            let avatarsHtml = zoneData.owners.map((u, index) => 
                `<img src="${u.avatar}" title="${u.name}" style="width:22px; height:22px; border-radius:50%; border:2px solid ${currentColor}; margin-left:${index === 0 ? 0 : -8}px; background:#000;">`
            ).join('');

            const labelContent = `
                <div style="display: flex; align-items: center; background: rgba(0,0,0,0.85); padding: 4px 10px; border-radius: 20px; border: 1px solid ${currentColor};">
                    <div style="display: flex; margin-right: 8px;">${avatarsHtml}</div>
                    <span style="font-size: 11px; font-weight: bold; color: white;">${zoneData.owners.length}</span>
                </div>`;

            zone.bindTooltip(labelContent, {
                permanent: true,
                direction: 'center',
                className: 'zone-label'
            }).openTooltip();
        }

        // Akcja kliknięcia - Zajmowanie/Dołączanie (Limit 1 strefa na gracza)
        zone.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            if (isDrawMode || !currentUser) return;

            const isAlreadyInThisZone = zoneData.owners.some(u => u.name === currentUser.username);
            if (isAlreadyInThisZone) return alert("Już należysz do tej strefy!");

            if (confirm("Czy chcesz dołączyć do tej strefy? (Zostaniesz usunięty z innych stref)")) {
                // 1. Usuń gracza z każdej innej strefy na mapie
                savedZones.forEach(z => {
                    if (z.owners) {
                        z.owners = z.owners.filter(u => u.name !== currentUser.username);
                    }
                });

                // 2. Dodaj gracza do tej konkretnej strefy
                zoneData.owners.push({
                    name: currentUser.username,
                    avatar: `https://cdn.discordapp.com/avatars/${currentUser.id}/${currentUser.avatar}.png`
                });

                saveZonesToServer();
                setTimeout(() => { location.reload(); }, 300);
            }
        });

        // Usuwanie strefy (Prawy przycisk - tylko admin)
        zone.on('contextmenu', (e) => {
            if (currentUser && currentUser.isAdmin) {
                if(confirm("Usunąć strefę całkowicie?")) {
                    map.removeLayer(zone);
                    savedZones = savedZones.filter(z => z.id !== zoneData.id);
                    saveZonesToServer();
                }
            }
        });
    }

    async function saveZonesToServer() {
        await fetch('/api/zones', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(savedZones)
        });
    }

    init();
</script>
</body>
</html>
