<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>FSBC Mapa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --bg: #0f111a; --sidebar: #1a1c24; --accent: #ff4757; }
        body { margin: 0; display: flex; height: 100vh; background: var(--bg); font-family: sans-serif; color: white; gap: 10px; padding: 10px; box-sizing: border-box; }
        #sidebar { width: 300px; background: var(--sidebar); padding: 20px; border-radius: 15px; z-index: 1000; }
        #map { flex-grow: 1; border-radius: 15px; background: #000; }
        .btn-discord { background: #5865F2; color: white; text-decoration: none; padding: 12px; border-radius: 8px; display: block; text-align: center; font-weight: bold; }
        .user-card { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; }
        #drawBtn { width: 100%; padding: 10px; margin-top: 10px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        
        /* Style dla napisów na strefach */
        .leaflet-tooltip.zone-label { background: transparent; border: none; box-shadow: none; padding: 0; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>FSBC LOBBY</h2>
    <div id="auth-section">
        <a href="/auth/discord" class="btn-discord">ZALOGUJ PRZEZ DISCORD</a>
    </div>
    <div id="profile-section" style="display:none;">
        <div class="user-card">
            <img id="user-avatar" src="" style="width:40px; border-radius:50%;">
            <div><b id="user-name"></b><br><small id="user-status"></small></div>
        </div>
        <div id="admin-tools" style="display:none; margin-top:15px; border-top:1px solid #333; padding-top:15px;">
            <button id="drawBtn" onclick="toggleDrawMode()">Dodaj Strefę</button>
        </div>
        <a href="/logout" style="color: #666; font-size: 12px; display: block; margin-top: 10px;">Wyloguj</a>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let currentUser = null;
    let isDrawMode = false;
    let firstPoint = null;
    let savedZones = [];

    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -0.5, maxZoom: 0, zoom: 0, zoomControl: false, attributionControl: false });
    const bounds = [[0, 0], [590, 670]];
    L.imageOverlay('https://i.imgur.com/uRj0p6o.png', bounds).addTo(map); // Użyj stabilnego linku Imgur
    map.fitBounds(bounds);

    async function init() {
        const res = await fetch('/api/user');
        currentUser = await res.json();
        if (currentUser) {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('profile-section').style.display = 'block';
            document.getElementById('user-name').innerText = currentUser.username;
            document.getElementById('user-avatar').src = `https://cdn.discordapp.com/avatars/${currentUser.id}/${currentUser.avatar}.png`;
            document.getElementById('user-status').innerText = currentUser.isAdmin ? "Moderator" : "Gracz";
            if (currentUser.isAdmin) document.getElementById('admin-tools').style.display = 'block';
        }
        loadZones();
    }

    async function loadZones() {
        const res = await fetch('/api/zones');
        savedZones = await res.json();
        savedZones.forEach(z => renderZone(z));
    }

    function toggleDrawMode() {
        isDrawMode = !isDrawMode;
        document.getElementById('drawBtn').innerText = isDrawMode ? 'KLIKNIJ 2 PUNKTY' : 'Dodaj Strefę';
    }

    map.on('click', (e) => {
        if (isDrawMode && currentUser?.isAdmin) {
            if (!firstPoint) {
                firstPoint = e.latlng;
            } else {
                const newZone = { id: Date.now(), p1: firstPoint, p2: e.latlng, color: '#ff4757', owner: null, ownerAvatar: null };
                savedZones.push(newZone);
                renderZone(newZone);
                saveZonesToServer();
                firstPoint = null;
                toggleDrawMode();
            }
        }
    });

    function renderZone(zoneData) {
        const zone = L.rectangle([zoneData.p1, zoneData.p2], { color: zoneData.color, fillOpacity: zoneData.owner ? 0.4 : 0.2 }).addTo(map);

        if (zoneData.owner) {
            const label = `<div style="display:flex; align-items:center; gap:5px; background:rgba(0,0,0,0.8); padding:3px 8px; border-radius:15px; color:white; border:1px solid ${zoneData.color};">
                <img src="${zoneData.ownerAvatar}" style="width:18px; height:18px; border-radius:50%">
                <span style="font-size:10px">${zoneData.owner}</span>
            </div>`;
            zone.bindTooltip(label, { permanent: true, direction: 'center', className: 'zone-label' }).openTooltip();
        }

        zone.on('contextmenu', () => {
            if (currentUser?.isAdmin && confirm("Usunąć?")) {
                map.removeLayer(zone);
                savedZones = savedZones.filter(z => z.id !== zoneData.id);
                saveZonesToServer();
            }
        });

        zone.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            if (isDrawMode || zoneData.owner || !currentUser) return;
            zoneData.owner = currentUser.username;
            zoneData.ownerAvatar = `https://cdn.discordapp.com/avatars/${currentUser.id}/${currentUser.avatar}.png`;
            zoneData.color = '#2ecc71';
            saveZonesToServer();
            location.reload();
        });
    }

    async function saveZonesToServer() {
        await fetch('/api/zones', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(savedZones) });
    }

    init();
</script>
</body>
</html>
