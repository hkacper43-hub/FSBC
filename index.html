<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSBC - SYSTEM TAKTYCZNY</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.5);
            --secondary: #a855f7;
            --bg-dark: #030712;
            --card-bg: rgba(3, 7, 18, 0.9);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); color: var(--text-main); min-height: 100vh; overflow-x: hidden; }
        
        #dynamic-bg { position: fixed; inset: 0; background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #030712 100%); z-index: -2; }
        .grid-pattern { position: fixed; inset: 0; background-image: linear-gradient(var(--glass-border) 1px, transparent 1px), linear-gradient(90deg, var(--glass-border) 1px, transparent 1px); background-size: 45px 45px; z-index: -1; opacity: 0.1; }

        /* MENU */
        .site-header { width: 100%; padding: 25px; display: flex; justify-content: center; gap: 40px; }
        .header-nav-item { color: #fff; text-decoration: none; font-size: 14px; font-weight: 600; opacity: 0.6; transition: 0.3s; cursor: pointer; position: relative; }
        .header-nav-item.active { opacity: 1; }
        .header-nav-item.active::after { content: ''; position: absolute; bottom: -5px; left: 0; width: 100%; height: 2px; background: var(--primary); }

        /* WIDOKI */
        .content-view { display: none; width: 100%; animation: fadeIn 0.4s ease; padding: 20px; }
        .content-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* KARTY TURNIEJÓW */
        .view-container-wide { width: 95%; max-width: 1400px; margin: 0 auto; }
        .section-title { font-size: clamp(32px, 5vw, 54px); font-weight: 800; margin-bottom: 40px; }
        .tournaments-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        
        .info-card { 
            background: var(--glass); border: 1px solid var(--glass-border); border-radius: 24px; padding: 30px; 
            transition: 0.3s; cursor: pointer; position: relative; overflow: hidden;
        }
        .info-card:hover { transform: translateY(-5px); border-color: var(--primary); background: rgba(255,255,255,0.05); }
        .status-badge { padding: 4px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; display: inline-block; }

        /* WIDOK ARCHIWUM */
        .archive-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; margin-top: 20px; }
        .stats-panel { background: var(--card-bg); border-radius: 24px; padding: 30px; border: 1px solid var(--glass-border); }
        .archive-map-frame { height: 600px; background: #000; border-radius: 24px; overflow: hidden; border: 1px solid var(--glass-border); }
        
        .winner-row { display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 15px; margin-bottom: 10px; }
        .rank-circle { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; }

        /* MAPA INTERAKTYWNA */
        .map-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--card-bg); padding: 15px 30px; border-radius: 20px; }
        .map-main-container { display: flex; gap: 20px; height: 750px; }
        #map { flex: 1; border-radius: 24px; background: #000; }
        #sidebar { width: 350px; background: var(--card-bg); border-radius: 24px; padding: 25px; border: 1px solid var(--glass-border); overflow-y: auto; }

        .btn-action { background: var(--primary); color: #fff; border: none; padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.3s; margin-bottom: 10px; }
        .btn-action:hover { filter: brightness(1.2); }
        .btn-admin { background: #dc2626; }
    </style>
</head>
<body>

    <div id="dynamic-bg"></div>
    <div class="grid-pattern"></div>

    <header class="site-header">
        <div class="header-nav-item active" id="nav-home" onclick="showView('home')">Home</div>
        <div class="header-nav-item" id="nav-tournaments" onclick="showView('tournaments')">Tournaments</div>
        <div class="header-nav-item" id="nav-info" onclick="showView('info')">Information</div>
    </header>

    <div id="view-home" class="content-view active">
        <div style="height: 70vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
            <h1 style="font-size: 80px; font-weight: 800; letter-spacing: -4px;">FSBC <span style="color:var(--primary)">TACTICAL</span></h1>
            <p style="color: var(--text-muted); max-width: 600px; margin-top: 10px;">Zarządzaj swoimi strefami zrzutu, analizuj poprzednie gry i przygotuj się na Solo Blitz Royale #5.</p>
            <button class="btn-action" style="width: auto; padding: 15px 40px; margin-top: 30px; border-radius: 50px;" onclick="showView('tournaments')">ROZPOCZNIJ</button>
        </div>
    </div>

    <div id="view-tournaments" class="content-view">
        <div class="view-container-wide">
            <h1 class="section-title">Turnieje</h1>
            <div class="tournaments-grid" id="tournaments-list"></div>
        </div>
    </div>

    <div id="view-archive" class="content-view">
        <div class="view-container-wide">
            <button onclick="showView('tournaments')" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-weight:700; margin-bottom:20px;">← POWRÓT DO LISTY</button>
            <h1 id="archive-title" class="section-title">Turniej #1</h1>
            <div class="archive-layout">
                <div class="stats-panel">
                    <h3 style="margin-bottom: 20px;">Wyniki Końcowe</h3>
                    <div id="archive-leaderboard"></div>
                </div>
                <div class="archive-map-frame" id="archive-map"></div>
            </div>
        </div>
    </div>

    <div id="view-map" class="content-view">
        <div class="view-container-wide">
            <div class="map-nav">
                <div style="display:flex; gap:10px;">
                    <button class="btn-action" id="btn-starfall" onclick="handleMapChange('starfall')" style="width:auto; padding:8px 20px;">Starfall</button>
                    <button class="btn-action" id="btn-venture" onclick="handleMapChange('venture')" style="width:auto; padding:8px 20px; background:rgba(255,255,255,0.05);">Venture</button>
                </div>
                <button onclick="showView('tournaments')" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-weight:700;">ZAMKNIJ MAPĘ</button>
            </div>
            <div class="map-main-container">
                <aside id="sidebar">
                    <div id="auth-ui"><a href="/auth/discord" class="btn-action" style="background:#5865F2; display:block; text-align:center; text-decoration:none;">ZALOGUJ PRZEZ DISCORD</a></div>
                    
                    <div id="profile-ui" style="display:none">
                        <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
                            <img id="u-avatar" src="" style="width:50px; border-radius:50%; border:2px solid var(--primary)">
                            <div><b id="u-name"></b><br><small id="u-role" style="color:var(--text-muted)">Gracz</small></div>
                        </div>

                        <div id="admin-panel" style="display:none; border: 1px solid #dc2626; padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                            <p style="font-size: 11px; color: #dc2626; font-weight: 800; margin-bottom: 10px;">NARZĘDZIA ADMINA</p>
                            <button id="drawBtn" class="btn-action btn-admin" onclick="toggleDrawing()">DODAJ NOWĄ STREFĘ</button>
                        </div>

                        <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">Twoja strefa:</p>
                        <div id="my-zone-info">Brak wybranej strefy</div>
                    </div>

                    <hr style="margin:20px 0; opacity:0.1">
                    <div id="player-list-ui">
                        <h4 style="margin-bottom: 10px;">Zajęte strefy:</h4>
                        <div id="zones-list-container"></div>
                    </div>
                </aside>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <div id="view-info" class="content-view">
        <div class="view-container-wide">
            <h1 class="section-title">Regulamin</h1>
            <p style="color:var(--text-muted)">1. Zakaz lootowania spotów przeciwnika do 3 strefy.<br>2. Zakaz teamowania.<br>3. Obowiązkowy voice-chat.</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // KONFIGURACJA
        const tournaments = [
            { id: 5, title: "FSBC Solo #5", status: "active", date: "Marzec 2026", winner: "TBD" },
            { id: 4, title: "FSBC Solo #4", status: "finished", date: "Luty 2026", winner: "szimicarson6", results: [ {n: "szimicarson6", p: 450}, {n: "Gracz2", p: 320} ] },
        ];

        let currentUser = null; 
        let isDrawing = false;
        let p1 = null; 
        let allZones = []; 
        let currentMap = 'starfall';
        let mainMap, archiveMap;

        // --- INICJALIZACJA ---
        function init() {
            renderTournaments();
            initMaps();
            checkUser();
            refreshZones();
        }

        function initMaps() {
            const conf = { crs: L.CRS.Simple, minZoom: -1, maxZoom: 2, zoomControl: false, attributionControl: false };
            mainMap = L.map('map', conf);
            archiveMap = L.map('archive-map', conf);
            
            L.imageOverlay('https://i.ibb.co/dss8R1Ph/mapa.png', [[0,0],[500,500]]).addTo(mainMap);
            L.imageOverlay('https://i.ibb.co/dss8R1Ph/mapa.png', [[0,0],[500,500]]).addTo(archiveMap);
            
            mainMap.setView([250, 250], 0);
            archiveMap.setView([250, 250], 0);

            // LOGIKA KLIKNIĘCIA W MAPĘ (DLA ADMINA)
            mainMap.on('click', (e) => {
                if (!isDrawing) return;

                if (!p1) {
                    p1 = [e.latlng.lat, e.latlng.lng];
                    L.circle(p1, {radius: 2, color: 'red'}).addTo(mainMap);
                } else {
                    const p2 = [e.latlng.lat, e.latlng.lng];
                    saveNewZone(p1, p2);
                    p1 = null;
                    toggleDrawing(); // Wyłącz tryb rysowania po dodaniu
                }
            });
        }

        // --- OBSŁUGA UŻYTKOWNIKA I RÓL ---
        async function checkUser() {
            // Symulacja admina dla testów: Jeśli Twój login to np. "szimicarson6"
            // W prawdziwym systemie pobierasz to z /api/user
            try {
                const r = await fetch('/api/user');
                const u = await r.json();
                if(u.id) {
                    currentUser = u;
                    // Prosty check roli (możesz to zmienić na u.isAdmin)
                    const isAdmin = true; // ZMIEŃ NA FALSE ŻEBY SPRAWDZIĆ WIDOK GRACZA

                    document.getElementById('auth-ui').style.display='none';
                    document.getElementById('profile-ui').style.display='block';
                    document.getElementById('u-name').innerText = u.username;
                    document.getElementById('u-avatar').src = `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png`;
                    
                    if(isAdmin) {
                        document.getElementById('admin-panel').style.display = 'block';
                        document.getElementById('u-role').innerText = "Administrator";
                    }
                }
            } catch(e) { console.log("Błąd autoryzacji"); }
        }

        // --- LOGIKA STREF (ADMIN) ---
        function toggleDrawing() {
            isDrawing = !isDrawing;
            const btn = document.getElementById('drawBtn');
            if(isDrawing) {
                btn.innerText = "KLIKNIJ 2 PUNKTY...";
                btn.style.background = "#4ade80";
            } else {
                btn.innerText = "DODAJ NOWĄ STREFĘ";
                btn.style.background = "#dc2626";
            }
        }

        async function saveNewZone(coord1, coord2) {
            const newZone = {
                id: Date.now(),
                map: currentMap,
                p1: coord1,
                p2: coord2,
                owners: [] // Pusta strefa na start
            };

            allZones.push(newZone);
            await syncZones();
            draw();
        }

        // --- LOGIKA WYBORU STREFY (GRACZ) ---
        async function toggleZoneSelection(z) {
            if(!currentUser) return alert("Zaloguj się!");

            // Sprawdź czy gracz ma już jakąś strefę (limit 1 strefa na gracza)
            const alreadyHasZone = allZones.find(zone => zone.owners.some(o => o.name === currentUser.username));
            
            // Jeśli klikasz w strefę, którą już masz - usuń zaznaczenie
            const isOwner = z.owners.some(o => o.name === currentUser.username);

            if (isOwner) {
                z.owners = z.owners.filter(o => o.name !== currentUser.username);
            } else {
                if(alreadyHasZone) {
                    alert("Możesz wybrać tylko jedną strefę! Usuń poprzednią najpierw.");
                    return;
                }
                if(z.owners.length > 0) {
                    alert("Ta strefa jest już zajęta!");
                    return;
                }
                z.owners.push({ name: currentUser.username, avatar: document.getElementById('u-avatar').src });
            }

            await syncZones();
            draw();
        }

        // --- SYNCHRONIZACJA I WYŚWIETLANIE ---
        async function syncZones() {
            try {
                await fetch('/api/zones', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(allZones)
                });
            } catch(e) { console.error("Błąd zapisu stref"); }
        }

        async function refreshZones() {
            try {
                const r = await fetch('/api/zones');
                allZones = await r.json();
                draw();
            } catch(e) { allZones = []; }
        }

        function draw() {
            // Czyścimy warstwy rysowane (prostokąty)
            mainMap.eachLayer(l => { if(l instanceof L.Rectangle || l instanceof L.Circle) mainMap.removeLayer(l); });

            const listContainer = document.getElementById('zones-list-container');
            listContainer.innerHTML = "";

            allZones.filter(z => z.map === currentMap).forEach(z => {
                const isOccupied = z.owners.length > 0;
                const isMine = z.owners.some(o => o.name === currentUser?.username);

                // Rysowanie na mapie
                L.rectangle([z.p1, z.p2], {
                    color: isMine ? '#4ade80' : (isOccupied ? '#ef4444' : '#6366f1'),
                    weight: 2,
                    fillOpacity: 0.2,
                    dashArray: isOccupied ? '' : '5, 5'
                }).addTo(mainMap).on('click', () => toggleZoneSelection(z));

                // Lista w sidebarze
                if(isOccupied) {
                    listContainer.innerHTML += `
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px; font-size:12px; background:rgba(255,255,255,0.05); padding:5px; border-radius:8px;">
                            <img src="${z.owners[0].avatar}" style="width:20px; border-radius:50%">
                            <span>${z.owners[0].name}</span>
                        </div>
                    `;
                }
            });
        }

        // --- NAWIGACJA ---
        function renderTournaments() {
            const container = document.getElementById('tournaments-list');
            container.innerHTML = tournaments.map(t => `
                <div class="info-card" onclick="handleTournamentClick(${t.id})">
                    <div class="status-badge" style="background:${t.status === 'active' ? 'var(--primary)' : 'rgba(255,255,255,0.1)'}">
                        ${t.status === 'active' ? 'Nadchodzi' : 'Zakończony'}
                    </div>
                    <h2>${t.title}</h2>
                    <p style="color:var(--text-muted); font-size:13px;">${t.date}</p>
                </div>
            `).join('');
        }

        function handleTournamentClick(id) {
            const t = tournaments.find(x => x.id === id);
            if(t.status === 'active') showView('map');
            else {
                showView('archive');
                document.getElementById('archive-title').innerText = t.title;
            }
        }

        function showView(v) {
            document.querySelectorAll('.content-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.header-nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + v).classList.add('active');
            if(v === 'map') setTimeout(() => mainMap.invalidateSize(), 200);
            window.scrollTo(0,0);
        }

        function handleMapChange(mapId) {
            currentMap = mapId;
            document.querySelectorAll('.map-nav .btn-action').forEach(b => b.style.background = 'rgba(255,255,255,0.05)');
            document.getElementById('btn-' + mapId).style.background = 'var(--primary)';
            draw();
        }

        init();
    </script>
</body>
</html>
