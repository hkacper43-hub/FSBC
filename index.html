<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSBC - SYSTEM TAKTYCZNY</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.5);
            --secondary: #a855f7;
            --bg-dark: #030712;
            --card-bg: rgba(3, 7, 18, 0.9);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); color: var(--text-main); min-height: 100vh; overflow-x: hidden; }
        
        #dynamic-bg { position: fixed; inset: 0; background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #030712 100%); z-index: -2; }
        .grid-pattern { position: fixed; inset: 0; background-image: linear-gradient(var(--glass-border) 1px, transparent 1px), linear-gradient(90deg, var(--glass-border) 1px, transparent 1px); background-size: 45px 45px; z-index: -1; opacity: 0.1; }

        /* MENU */
        .site-header { width: 100%; padding: 25px; display: flex; justify-content: center; gap: 40px; }
        .header-nav-item { color: #fff; text-decoration: none; font-size: 14px; font-weight: 600; opacity: 0.6; transition: 0.3s; cursor: pointer; position: relative; }
        .header-nav-item.active { opacity: 1; }
        .header-nav-item.active::after { content: ''; position: absolute; bottom: -5px; left: 0; width: 100%; height: 2px; background: var(--primary); }

        /* WIDOKI */
        .content-view { display: none; width: 100%; animation: fadeIn 0.4s ease; padding: 20px; }
        .content-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* KARTY TURNIEJÓW */
        .view-container-wide { width: 95%; max-width: 1400px; margin: 0 auto; }
        .section-title { font-size: clamp(32px, 5vw, 54px); font-weight: 800; margin-bottom: 40px; }
        .tournaments-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        
        .info-card { 
            background: var(--glass); border: 1px solid var(--glass-border); border-radius: 24px; padding: 30px; 
            transition: 0.3s; cursor: pointer; position: relative; overflow: hidden;
        }
        .info-card:hover { transform: translateY(-5px); border-color: var(--primary); background: rgba(255,255,255,0.05); }
        .status-badge { padding: 4px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; margin-bottom: 15px; display: inline-block; }

        /* WIDOK ARCHIWUM */
        .archive-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; margin-top: 20px; }
        .stats-panel { background: var(--card-bg); border-radius: 24px; padding: 30px; border: 1px solid var(--glass-border); }
        .archive-map-frame { height: 600px; background: #000; border-radius: 24px; overflow: hidden; border: 1px solid var(--glass-border); }
        
        .winner-row { display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 15px; margin-bottom: 10px; }
        .rank-circle { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; }

        /* MAPA INTERAKTYWNA */
        .map-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--card-bg); padding: 15px 30px; border-radius: 20px; }
        .map-main-container { display: flex; gap: 20px; height: 750px; }
        #map { flex: 1; border-radius: 24px; }
        #sidebar { width: 350px; background: var(--card-bg); border-radius: 24px; padding: 25px; border: 1px solid var(--glass-border); }

        .btn-action { background: var(--primary); color: #fff; border: none; padding: 12px; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn-action:hover { filter: brightness(1.2); }
    </style>
</head>
<body>

    <div id="dynamic-bg"></div>
    <div class="grid-pattern"></div>

    <header class="site-header">
        <div class="header-nav-item active" id="nav-home" onclick="showView('home')">Home</div>
        <div class="header-nav-item" id="nav-tournaments" onclick="showView('tournaments')">Tournaments</div>
        <div class="header-nav-item" id="nav-info" onclick="showView('info')">Information</div>
    </header>

    <div id="view-home" class="content-view active">
        <div style="height: 70vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
            <h1 style="font-size: 80px; font-weight: 800; letter-spacing: -4px;">FSBC <span style="color:var(--primary)">TACTICAL</span></h1>
            <p style="color: var(--text-muted); max-width: 600px; margin-top: 10px;">Zarządzaj swoimi strefami zrzutu, analizuj poprzednie gry i przygotuj się na Solo Blitz Royale #5.</p>
            <button class="btn-action" style="width: auto; padding: 15px 40px; margin-top: 30px; border-radius: 50px;" onclick="showView('tournaments')">ROZPOCZNIJ</button>
        </div>
    </div>

    <div id="view-tournaments" class="content-view">
        <div class="view-container-wide">
            <h1 class="section-title">Turnieje</h1>
            <div class="tournaments-grid" id="tournaments-list">
                </div>
        </div>
    </div>

    <div id="view-archive" class="content-view">
        <div class="view-container-wide">
            <button onclick="showView('tournaments')" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-weight:700; margin-bottom:20px;">← POWRÓT DO LISTY</button>
            <h1 id="archive-title" class="section-title">Turniej #1</h1>
            
            <div class="archive-layout">
                <div class="stats-panel">
                    <h3 style="margin-bottom: 20px;">Wyniki Końcowe</h3>
                    <div id="archive-leaderboard">
                        </div>
                </div>
                <div class="archive-map-frame" id="archive-map"></div>
            </div>
        </div>
    </div>

    <div id="view-map" class="content-view">
        <div class="view-container-wide">
            <div class="map-nav">
                <div style="display:flex; gap:10px;">
                    <button class="btn-action active" id="btn-starfall" onclick="handleMapChange('starfall')" style="width:auto; padding:8px 20px;">Starfall</button>
                    <button class="btn-action" id="btn-venture" onclick="handleMapChange('venture')" style="width:auto; padding:8px 20px; background:rgba(255,255,255,0.05);">Venture</button>
                </div>
                <button onclick="showView('tournaments')" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-weight:700;">ZAMKNIJ MAPĘ</button>
            </div>
            <div class="map-main-container">
                <aside id="sidebar">
                    <div id="auth-ui"><a href="/auth/discord" class="btn-action" style="background:#5865F2; display:block; text-align:center; text-decoration:none;">ZALOGUJ PRZEZ DISCORD</a></div>
                    <div id="profile-ui" style="display:none">
                        <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
                            <img id="u-avatar" src="" style="width:50px; border-radius:50%; border:2px solid var(--primary)">
                            <div><b id="u-name"></b><br><small style="color:var(--text-muted)">Gracz Turniejowy</small></div>
                        </div>
                        <button id="drawBtn" class="btn-action" onclick="toggleDrawing()" style="background:var(--secondary)">DODAJ SWÓJ SPOT</button>
                    </div>
                    <hr style="margin:20px 0; opacity:0.1">
                    <div id="player-list-ui"></div>
                </aside>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <div id="view-info" class="content-view">
        <div class="view-container-wide">
            <h1 class="section-title">Regulamin</h1>
            <p style="color:var(--text-muted)">1. Zakaz lootowania spotów przeciwnika do 3 strefy.<br>2. Zakaz teamowania.<br>3. Obowiązkowy voice-chat.</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // DANE TURNIEJÓW
        const tournaments = [
            { id: 5, title: "FSBC Solo #5", status: "active", date: "Marzec 2026", winner: "TBD" },
            { id: 4, title: "FSBC Solo #4", status: "finished", date: "Luty 2026", winner: "szimicarson6", results: [ {n: "szimicarson6", p: 450}, {n: "Gracz2", p: 320}, {n: "Gracz3", p: 210} ] },
            { id: 3, title: "FSBC Solo #3", status: "finished", date: "Luty 2026", winner: "szimicarson6", results: [ {n: "szimicarson6", p: 510}, {n: "ProPlayer", p: 480}, {n: "Xyz", p: 300} ] },
            { id: 2, title: "FSBC Solo #2", status: "finished", date: "Styczeń 2026", winner: "szimicarson6", results: [ {n: "szimicarson6", p: 390}, {n: "Lucky", p: 380}, {n: "Noob", p: 100} ] },
            { id: 1, title: "FSBC Solo #1", status: "finished", date: "Styczeń 2026", winner: "szimicarson6", results: [ {n: "szimicarson6", p: 600}, {n: "Enemy", p: 400}, {n: "Bot", p: 50} ] },
        ];

        let currentUser = null, isDrawing = false, p1 = null, allZones = [], currentMap = 'starfall';
        let mainMap, archiveMap;

        // INICJALIZACJA
        function init() {
            renderTournaments();
            initMaps();
            checkUser();
            refreshZones();
        }

        function renderTournaments() {
            const container = document.getElementById('tournaments-list');
            container.innerHTML = tournaments.map(t => `
                <div class="info-card" onclick="handleTournamentClick(${t.id})">
                    <div class="status-badge" style="background:${t.status === 'active' ? 'var(--primary)' : 'rgba(255,255,255,0.1)'}">
                        ${t.status === 'active' ? 'Nadchodzi' : 'Zakończony'}
                    </div>
                    <h2 style="margin-bottom:5px;">${t.title}</h2>
                    <p style="color:var(--text-muted); font-size:13px; font-weight:600;">${t.date}</p>
                    <div style="margin-top:20px; font-size:14px;">
                        ${t.status === 'active' ? '<b style="color:var(--primary)">Kliknij, aby otworzyć mapę →</b>' : `Winner: <b>${t.winner}</b>`}
                    </div>
                </div>
            `).join('');
        }

        function handleTournamentClick(id) {
            const t = tournaments.find(x => x.id === id);
            if(t.status === 'active') {
                showView('map');
            } else {
                openArchive(t);
            }
        }

        function openArchive(t) {
            showView('archive');
            document.getElementById('archive-title').innerText = t.title;
            const lb = document.getElementById('archive-leaderboard');
            lb.innerHTML = t.results.map((r, i) => `
                <div class="winner-row">
                    <div class="rank-circle" style="background:${i === 0 ? 'gold' : i === 1 ? '#c0c0c0' : '#cd7f32'}; color:#000">#${i+1}</div>
                    <div style="flex:1"><b>${r.n}</b></div>
                    <div style="color:var(--primary)">${r.p} pkt</div>
                </div>
            `).join('');
            
            // Symulacja mapy archiwalnej
            setTimeout(() => archiveMap.invalidateSize(), 200);
        }

        function initMaps() {
            const conf = { crs: L.CRS.Simple, minZoom: -1, maxZoom: 2, zoomControl: false, attributionControl: false };
            mainMap = L.map('map', conf);
            archiveMap = L.map('archive-map', conf);
            
            L.imageOverlay('https://i.ibb.co/dss8R1Ph/mapa.png', [[0,0],[500,500]]).addTo(mainMap);
            L.imageOverlay('https://i.ibb.co/dss8R1Ph/mapa.png', [[0,0],[500,500]]).addTo(archiveMap);
            
            mainMap.setView([250, 250], 0);
            archiveMap.setView([250, 250], 0);
        }

        function showView(v) {
            document.querySelectorAll('.content-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.header-nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + v).classList.add('active');
            if(document.getElementById('nav-' + v)) document.getElementById('nav-' + v).classList.add('active');
            if(v === 'map') setTimeout(() => mainMap.invalidateSize(), 200);
            window.scrollTo(0,0);
        }

        // LOGIKA MAPY (SKRÓCONA DO DZIAŁANIA)
        async function checkUser() {
            try {
                const r = await fetch('/api/user');
                const u = await r.json();
                if(u.id) {
                    currentUser = u;
                    document.getElementById('auth-ui').style.display='none';
                    document.getElementById('profile-ui').style.display='block';
                    document.getElementById('u-name').innerText = u.username;
                    document.getElementById('u-avatar').src = `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png`;
                }
            } catch(e){}
        }

        async function refreshZones() {
            try {
                const r = await fetch('/api/zones');
                allZones = await r.json();
                draw();
            } catch(e){}
        }

        function draw() {
            mainMap.eachLayer(l => { if(l instanceof L.Rectangle) mainMap.removeLayer(l); });
            allZones.filter(z => z.map === currentMap).forEach(z => {
                L.rectangle([z.p1, z.p2], { color: z.owners.length > 1 ? 'red' : 'green', fillOpacity: 0.3 }).addTo(mainMap)
                 .on('click', () => { if(currentUser) toggleZone(z); });
            });
        }

        async function toggleZone(z) {
            const exists = z.owners.find(o => o.name === currentUser.username);
            if(exists) z.owners = z.owners.filter(o => o.name !== currentUser.username);
            else z.owners.push({ name: currentUser.username, avatar: document.getElementById('u-avatar').src });
            await fetch('/api/zones', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(allZones)});
            draw();
        }

        init();
    </script>
</body>
</html>
