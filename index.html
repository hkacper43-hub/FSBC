<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSBC SYSTEM | Tournament Management</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.5);
            --secondary: #a855f7;
            --accent: #d946ef;
            --bg-dark: #030712;
            --card-bg: rgba(3, 7, 18, 0.95);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.12);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #2ecc71;
            --discord: #5865F2;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-font-smoothing: antialiased; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); color: var(--text-main); min-height: 100vh; overflow-x: hidden; padding-bottom: 50px; }
        
        #dynamic-bg { position: fixed; inset: 0; background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #030712 100%); z-index: -2; }
        .grid-pattern { position: fixed; inset: 0; background-image: linear-gradient(var(--glass-border) 1px, transparent 1px), linear-gradient(90deg, var(--glass-border) 1px, transparent 1px); background-size: 45px 45px; z-index: -1; opacity: 0.1; }

        /* HEADER */
        .site-header { width: 100%; max-width: 1600px; margin: 0 auto; padding: 25px 40px; display: flex; justify-content: center; gap: 40px; position: sticky; top: 0; z-index: 1000; background: linear-gradient(to bottom, var(--bg-dark) 80%, transparent); }
        .header-nav-item { color: #ffffff; text-decoration: none; font-size: 13px; font-weight: 700; letter-spacing: 1.5px; opacity: 0.5; transition: 0.3s; position: relative; cursor: pointer; text-transform: uppercase; }
        .header-nav-item:hover, .header-nav-item.active { opacity: 1; color: var(--primary); }
        .header-nav-item::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 2px; background: var(--primary); transition: 0.3s; }
        .header-nav-item.active::after { width: 100%; }

        /* VIEWS */
        .content-view { display: none; width: 100%; animation: viewIn 0.5s ease forwards; }
        .content-view.active { display: block; }
        @keyframes viewIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* HERO SECTION */
        .hero-section { height: 60vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .hero-title { font-size: clamp(40px, 8vw, 90px); font-weight: 900; background: linear-gradient(135deg, #fff 20%, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px; letter-spacing: -3px; }
        .hero-subtitle { color: var(--text-muted); max-width: 600px; margin-bottom: 35px; font-size: 18px; }

        /* MAP INTERFACE */
        .map-top-bar { width: 96%; max-width: 1800px; margin: 10px auto 20px auto; display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px 30px; border-radius: 20px; border: 1px solid var(--glass-border); }
        .map-layout { display: flex; width: 96%; max-width: 1800px; margin: 0 auto; gap: 20px; height: 800px; }
        #sidebar { width: 380px; background: var(--card-bg); border: 1px solid var(--glass-border); border-radius: 30px; padding: 25px; display: flex; flex-direction: column; gap: 20px; }
        .map-frame { flex-grow: 1; background: #000; border: 1px solid var(--glass-border); border-radius: 30px; overflow: hidden; position: relative; }
        #map { width: 100%; height: 100%; }

        .nav-btn { padding: 10px 25px; border: none; background: rgba(255,255,255,0.05); color: var(--text-muted); font-weight: 700; font-size: 12px; cursor: pointer; border-radius: 12px; transition: 0.3s; text-transform: uppercase; }
        .nav-btn.active { background: var(--primary); color: white; }

        /* TOURNAMENT CARDS */
        .tournament-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; width: 90%; max-width: 1400px; margin: 40px auto; }
        .t-card { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 35px; padding: 45px; position: relative; overflow: hidden; transition: 0.4s; }
        .t-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .t-badge { background: var(--primary); color: white; padding: 5px 15px; border-radius: 10px; font-size: 11px; font-weight: 800; text-transform: uppercase; display: inline-block; margin-bottom: 20px; }
        
        .card-footer-btns { display: flex; gap: 15px; margin-top: 30px; }
        .footer-link { text-decoration: none; flex: 1; padding: 15px; border-radius: 15px; text-align: center; font-weight: 800; font-size: 12px; text-transform: uppercase; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-map { background: rgba(99, 102, 241, 0.1); color: var(--primary); border: 1px solid rgba(99, 102, 241, 0.2); }
        .btn-map:hover { background: var(--primary); color: white; }
        .btn-leader { background: rgba(217, 70, 239, 0.1); color: var(--accent); border: 1px solid rgba(217, 70, 239, 0.2); }
        .btn-leader:hover { background: var(--accent); color: white; }

        /* UI ELEMENTS */
        .player-entry { display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 15px; margin-bottom: 10px; border: 1px solid transparent; }
        .player-entry.me { border-color: var(--success); background: rgba(46, 204, 113, 0.05); }
        .player-entry img { width: 35px; height: 35px; border-radius: 50%; }

        .avatar-cluster { display: flex; align-items: center; background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 20px; border: 2px solid var(--primary); }
        .cluster-img { width: 30px; height: 30px; border-radius: 50%; border: 1px solid white; margin-right: -10px; }

        .status-msg { padding: 15px; border-radius: 15px; font-size: 12px; font-weight: 600; line-height: 1.5; margin-bottom: 20px; }
        .msg-warning { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .msg-success { background: rgba(46, 204, 113, 0.1); color: var(--success); border: 1px solid var(--success); }
    </style>
</head>
<body>

    <div id="dynamic-bg"></div>
    <div class="grid-pattern"></div>

    <header class="site-header">
        <div class="header-nav-item active" id="nav-home" onclick="showView('home')">Home</div>
        <div class="header-nav-item" id="nav-map" onclick="showView('map')">System Map</div>
        <div class="header-nav-item" id="nav-tournaments" onclick="showView('tournaments')">Turnieje</div>
        <div class="header-nav-item" id="nav-info" onclick="showView('info')">Informacje</div>
    </header>

    <div id="view-home" class="content-view active">
        <section class="hero-section">
            <h1 class="hero-title">FSBC TOURNAMENTS</h1>
            <p class="hero-subtitle">Profesjonalny system rezerwacji drop-spotów dla Liderów Duo. Zaloguj się, aby zarządzać taktyką swojego zespołu.</p>
            <button class="nav-btn active" style="padding: 20px 50px; border-radius: 100px; font-size: 16px;" onclick="showView('map')">WEJDŹ DO SYSTEMU</button>
        </section>
    </div>

    <div id="view-tournaments" class="content-view">
        <div class="tournament-grid">
            <div class="t-card" style="border: 2px solid var(--primary);">
                <span class="t-badge">Aktywny</span>
                <h2 style="font-size: 36px; margin-bottom: 10px;">FSBC Duo Cup #5</h2>
                <p style="color: var(--text-muted); font-size: 15px;">Turniej przeznaczony dla zweryfikowanych par. Liderzy z rangą turniejową wybierają spoty na mapie Starfall.</p>
                
                <div class="card-footer-btns">
                    <a href="#" class="footer-link btn-map" onclick="enterTournamentMap('starfall')">
                        <i class="fa-solid fa-map-location-dot"></i> Mapa Turnieju
                    </a>
                    <a href="https://yunite.xyz/leaderboard/f406ce8e-205b-49ae-ae9d-076ea8c66aee" target="_blank" class="footer-link btn-leader">
                        <i class="fa-solid fa-ranking-star"></i> Leaderboard
                    </a>
                </div>
            </div>

            <div class="t-card">
                <span class="t-badge" style="background: grey;">Zakończony</span>
                <h2 style="font-size: 32px; margin-bottom: 10px;">FSBC Solo #4</h2>
                <p style="color: var(--text-muted); font-size: 14px;">Zakończono: Luty 2026. Gratulacje dla zwycięzców poprzedniej edycji.</p>
                <div class="card-footer-btns">
                    <a href="#" class="footer-link btn-leader" style="width: 100%;">ZOBACZ ARCHIWUM</a>
                </div>
            </div>
        </div>
    </div>

    <div id="view-map" class="content-view">
        <div class="map-top-bar">
            <div style="display: flex; gap: 10px;">
                <button class="nav-btn active" id="btn-starfall" onclick="changeMap('starfall')">Starfall</button>
                <button class="nav-btn" id="btn-venture" onclick="changeMap('venture')">Venture</button>
            </div>
            <div id="user-info-bar" style="font-weight: 800; font-size: 12px; color: var(--primary);">
                <i class="fa-solid fa-shield-halved"></i> TRYB: WERYFIKACJA RANGI
            </div>
        </div>

        <div class="map-layout">
            <aside id="sidebar">
                <div id="auth-section">
                    <a href="/auth/discord" class="nav-btn active" style="display: block; text-align: center; text-decoration: none; padding: 18px;">
                        <i class="fa-brands fa-discord"></i> LOGOWANIE LIDER
                    </a>
                </div>

                <div id="user-profile" style="display: none;">
                    <div class="player-entry" style="background: rgba(99, 102, 241, 0.15); border: 1px solid var(--primary);">
                        <img id="u-avatar" src="">
                        <div>
                            <b id="u-name">Lider Duo</b>
                            <div id="role-tag" style="font-size: 10px; color: var(--primary); font-weight: 800;">FSBC #5 VERIFIED</div>
                        </div>
                    </div>
                    
                    <div id="access-msg" class="status-msg"></div>

                    <button id="adminBtn" class="nav-btn" style="width: 100%; margin-top: 10px; display: none;" onclick="toggleDraw()">
                        DODAJ STREFĘ (ADMIN)
                    </button>
                </div>

                <div style="flex-grow: 1; overflow-y: auto;">
                    <h5 style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 15px;">Aktywne Rezerwacje</h5>
                    <div id="reservation-list"></div>
                </div>
            </aside>

            <main class="map-frame">
                <div id="map"></div>
            </main>
        </div>
    </div>

    <div id="view-info" class="content-view">
        <div style="width: 90%; max-width: 1000px; margin: 50px auto;">
            <div class="t-card">
                <h2 style="margin-bottom: 25px; color: var(--primary);">Zasady Lidera Duo</h2>
                <div style="display: flex; flex-direction: column; gap: 20px; color: var(--text-muted);">
                    <p>1. Tylko jedna osoba z Duo (Lider) może posiadać rangę <b>FSBC #5</b>.</p>
                    <p>2. Wybrany spot na mapie obowiązuje obu graczy z drużyny.</p>
                    <p>3. System automatycznie blokuje możliwość zajęcia dwóch miejsc przez tego samego lidera.</p>
                    <p>4. Zmiana spotu jest możliwa w dowolnym momencie przed startem meczu.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // TWOJE DANE KONFIGURACYJNE
        const TOURNAMENT_ROLE_ID = "1474787200758452369";
        let currentUser = null, allZones = [], currentMap = 'starfall', isDrawing = false, p1 = null;

        const maps = {
            starfall: { url: 'https://i.ibb.co/dss8R1Ph/mapa.png', bounds: [[0,0], [500,500]] },
            venture: { url: 'https://i.ibb.co/fzjBkhTX/image.png', bounds: [[0,0], [500,500]] }
        };

        const map = L.map('map', { crs: L.CRS.Simple, minZoom: -1, zoomControl: false, attributionControl: false });
        let overlay = L.imageOverlay(maps.starfall.url, maps.starfall.bounds).addTo(map);
        map.fitBounds(maps.starfall.bounds);

        function showView(id) {
            document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.header-nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.getElementById('nav-'+id).classList.add('active');
            if(id === 'map') setTimeout(() => map.invalidateSize(), 200);
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function enterTournamentMap(m) { showView('map'); changeMap(m); }

        async function init() {
            try {
                const r = await fetch('/api/user');
                const u = await r.json();
                
                if(u.id) {
                    currentUser = u;
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('user-profile').style.display = 'block';
                    document.getElementById('u-name').innerText = u.username;
                    document.getElementById('u-avatar').src = u.avatar ? `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png` : 'https://via.placeholder.com/40';
                    
                    // LOGIKA WERYFIKACJI RANGI
                    const msgBox = document.getElementById('access-msg');
                    if(u.roles && u.roles.includes(TOURNAMENT_ROLE_ID)) {
                        msgBox.innerText = "Weryfikacja pomyślna. Możesz zajmować spot.";
                        msgBox.className = "status-msg msg-success";
                        currentUser.canVote = true;
                    } else {
                        msgBox.innerText = "Brak rangi FSBC #5. Skontaktuj się z administratorem.";
                        msgBox.className = "status-msg msg-warning";
                        currentUser.canVote = false;
                    }

                    if(u.isAdmin) document.getElementById('adminBtn').style.display = 'block';
                }
            } catch(e){}
            load(); setInterval(load, 5000);
        }

        async function load() {
            try {
                const r = await fetch('/api/zones');
                const d = await r.json();
                if(!isDrawing) { allZones = d; render(); }
            } catch(e){}
        }

        function render() {
            map.eachLayer(l => { if(l instanceof L.Rectangle || l instanceof L.Tooltip) map.removeLayer(l); });
            const list = document.getElementById('reservation-list');
            list.innerHTML = '';
            
            allZones.filter(z => z.map === currentMap).forEach(z => {
                const count = z.owners.length;
                let color = count === 0 ? "#fff" : (count === 1 ? "#2ecc71" : "#ef4444");
                
                const rect = L.rectangle([z.p1, z.p2], { color: color, weight: 2, fillOpacity: 0.15 }).addTo(map);
                
                if(count > 0) {
                    const avatars = z.owners.map(o => `<img src="${o.avatar}" class="cluster-img">`).join('');
                    rect.bindTooltip(`<div class="avatar-cluster">${avatars}</div>`, { permanent: true, direction: 'center', className: 'zone-tooltip' }).openTooltip();
                    
                    z.owners.forEach(o => {
                        const isMe = currentUser && o.name === currentUser.username;
                        list.innerHTML += `
                            <div class="player-row ${isMe ? 'me' : ''}">
                                <img src="${o.avatar}">
                                <span>${o.name}</span>
                            </div>`;
                    });
                }

                rect.on('click', () => { 
                    if(currentUser && currentUser.canVote) toggleReservation(z); 
                    else if(currentUser) alert("Brak uprawnień (Ranga FSBC #5 wymagana)!");
                });

                if(currentUser?.isAdmin) rect.on('contextmenu', (e) => { 
                    L.DomEvent.stopPropagation(e);
                    if(confirm("Usunąć strefę?")) { allZones = allZones.filter(x => x.id !== z.id); sync(); }
                });
            });
        }

        async function toggleReservation(z) {
            const alreadyThere = z.owners.some(o => o.name === currentUser.username);
            
            // USUŃ MNIE Z INNYCH SPOTÓW NA TEJ MAPIE (Logika 1 spot na lidera)
            allZones.forEach(zone => {
                if(zone.map === currentMap) {
                    zone.owners = zone.owners.filter(o => o.name !== currentUser.username);
                }
            });

            // DODAJ DO NOWEGO JEŚLI NIE BYŁO MNIE TAM
            if(!alreadyThere) {
                z.owners.push({ name: currentUser.username, avatar: document.getElementById('u-avatar').src });
            }
            
            sync();
        }

        async function sync() {
            await fetch('/api/zones', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(allZones)});
            render();
        }

        function changeMap(m) {
            currentMap = m;
            document.querySelectorAll('.map-top-bar .nav-btn').forEach(b => b.classList.toggle('active', b.id === 'btn-'+m));
            overlay.setUrl(maps[m].url);
            render();
        }

        function toggleDraw() { isDrawing = !isDrawing; p1 = null; document.getElementById('adminBtn').innerText = isDrawing ? "ANULUJ" : "DODAJ STREFĘ (ADMIN)"; }
        
        map.on('click', (e) => {
            if(!isDrawing) return;
            if(!p1) p1 = e.latlng;
            else {
                allZones.push({ id: Date.now(), map: currentMap, p1: [p1.lat, p1.lng], p2: [e.latlng.lat, e.latlng.lng], owners: [] });
                p1 = null; toggleDraw(); sync();
            }
        });

        init();
    </script>
</body>
</html>
