<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSBC - SYSTEM TAKTYCZNY MAP</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.5);
            --secondary: #a855f7;
            --accent: #ec4899;
            --bg-dark: #030712;
            --card-bg: rgba(3, 7, 18, 0.85);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #2ecc71;
            --danger: #ef4444;
        }

        /* PODSTAWY I SCROLL */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            min-height: 100vh;
            overflow-y: auto; /* Włącza scrollowanie w dół */
            padding-bottom: 50px;
        }

        /* EFEKTY TŁA */
        #dynamic-bg { 
            position: fixed; inset: 0; 
            background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #030712 100%); 
            z-index: -2; transition: opacity 1s ease; 
        }
        .grid-pattern { 
            position: fixed; inset: 0; 
            background-image: linear-gradient(var(--glass-border) 1px, transparent 1px), 
                              linear-gradient(90deg, var(--glass-border) 1px, transparent 1px); 
            background-size: 50px 50px; z-index: -1; opacity: 0.1; 
        }

        /* GÓRNY PANEL NAWIGACYJNY */
        .top-navbar { 
            width: 95%; max-width: 1600px; margin: 20px auto; height: 90px; 
            background: var(--card-bg); backdrop-filter: blur(25px); 
            border: 1px solid var(--glass-border); border-radius: 25px; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 40px; z-index: 1000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .map-selector { 
            display: flex; background: rgba(0,0,0,0.4); 
            padding: 6px; border-radius: 18px; gap: 10px; 
            border: 1px solid var(--glass-border); 
        }
        .nav-btn { 
            padding: 14px 30px; border: none; background: transparent; 
            color: var(--text-muted); font-weight: 700; font-size: 13px; 
            cursor: pointer; border-radius: 14px; transition: all 0.4s ease;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .nav-btn.active { 
            background: var(--primary); color: white; 
            box-shadow: 0 10px 25px var(--primary-glow); 
        }

        .nav-stats { display: flex; align-items: center; gap: 20px; }
        .stat-badge { 
            background: rgba(255,255,255,0.05); padding: 12px 25px; 
            border-radius: 15px; border: 1px solid var(--glass-border); 
            display: flex; align-items: center; gap: 12px; font-weight: 800; 
        }
        .leaderboard-btn { 
            background: linear-gradient(45deg, var(--secondary), var(--accent)); 
            color: white; text-decoration: none; padding: 14px 30px; 
            border-radius: 15px; font-weight: 800; font-size: 13px; 
            box-shadow: 0 10px 25px rgba(168, 85, 247, 0.4);
            transition: transform 0.3s ease;
        }
        .leaderboard-btn:hover { transform: translateY(-3px); }

        /* UKŁAD GŁÓWNY (SIDEBAR + MAPA) */
        .content-layout {
            display: flex; width: 95%; max-width: 1600px; 
            margin: 0 auto; gap: 25px; align-items: flex-start;
        }

        /* SIDEBAR - LISTA I PROFIL */
        #sidebar { 
            width: 380px; min-width: 380px; background: var(--card-bg); 
            backdrop-filter: blur(25px); border: 1px solid var(--glass-border); 
            border-radius: 30px; padding: 35px; display: flex; 
            flex-direction: column; gap: 25px; box-shadow: 0 25px 60px rgba(0,0,0,0.5);
        }

        .search-box {
            position: relative; width: 100%; margin-bottom: 5px;
        }
        .search-box input {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            padding: 15px 15px 15px 45px; border-radius: 15px; color: white; font-family: inherit;
        }
        .search-box i { position: absolute; left: 18px; top: 18px; color: var(--text-muted); }

        .player-list-scroll {
            max-height: 450px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
        }
        .player-item {
            display: flex; align-items: center; gap: 15px; padding: 12px;
            background: rgba(255,255,255,0.02); border-radius: 15px; border: 1px solid transparent;
            transition: 0.3s ease;
        }
        .player-item:hover { background: var(--glass); border-color: var(--glass-border); }
        .player-item img { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--primary); }
        .player-item span { font-weight: 600; font-size: 14px; }

        /* KONTENER MAPY Z OUTLINE */
        .map-outline {
            flex-grow: 1; background: var(--card-bg); backdrop-filter: blur(25px); 
            border: 1px solid var(--glass-border); border-radius: 30px; 
            padding: 18px; box-shadow: 0 30px 70px rgba(0,0,0,0.6);
            height: 800px; position: relative;
        }
        #map { 
            width: 100%; height: 100%; border-radius: 20px; 
            background: #0d1117; z-index: 1;
        }

        /* TWOJE AVATARY NA MAPIE */
        .avatar-badge-stack { 
            display: flex; align-items: center; background: rgba(0, 0, 0, 0.85); 
            padding: 6px 15px; border-radius: 30px; border: 2.5px solid white; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .badge-img { width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; margin-right: -12px; }
        .badge-count { margin-left: 22px; font-weight: 800; font-size: 15px; color: white; }
        .zone-tooltip { background: transparent !important; border: none !important; box-shadow: none !important; }

        /* PROFILE CARD */
        .user-profile { 
            background: var(--glass); padding: 20px; border-radius: 20px; 
            border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 15px;
        }
        .user-profile img { width: 55px; height: 55px; border-radius: 50%; border: 3px solid var(--primary); }

        #adminBtn { 
            width: 100%; padding: 18px; border-radius: 18px; border: 1.5px dashed var(--primary);
            background: transparent; color: white; font-weight: 800; cursor: pointer; transition: 0.3s;
        }
        #adminBtn.active { background: var(--danger); border-style: solid; border-color: var(--danger); }

        /* SCROLLBAR CUSTOM */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="dynamic-bg"></div>
    <div class="grid-pattern"></div>

    <nav class="top-navbar">
        <div class="map-selector">
            <button class="nav-btn active" id="btn-starfall" onclick="changeMap('starfall')">Starfall</button>
            <button class="nav-btn" id="btn-venture" onclick="changeMap('venture')">Venture</button>
        </div>

        <div class="nav-stats">
            <div class="stat-badge"><i class="fa-solid fa-users" style="color: var(--primary);"></i> AKTYWNI: <span id="count-total">0</span></div>
            <a href="https://yunite.xyz/leaderboard/f406ce8e-205b-49ae-ae9d-076ea8c66aee" target="_blank" class="leaderboard-btn">
                <i class="fa-solid fa-trophy"></i> LEADERBOARD
            </a>
        </div>
    </nav>

    <div class="content-layout">
        <aside id="sidebar">
            <div id="auth-section">
                <a href="/auth/discord" style="text-decoration:none; background:#5865F2; color:white; padding:18px; border-radius:18px; display:block; text-align:center; font-weight:800;">
                    <i class="fa-brands fa-discord"></i> ZALOGUJ DISCORD
                </a>
            </div>

            <div id="logged-section" style="display: none;">
                <div class="user-profile">
                    <img id="u-avatar" src="" alt="Avatar">
                    <div>
                        <b id="u-name" style="font-size: 16px;">Nazwa</b><br>
                        <span id="u-role" style="font-size: 12px; color: var(--text-muted);">Użytkownik FSBC</span>
                    </div>
                </div>
                <div id="admin-panel" style="display: none; margin-top: 15px;">
                    <button id="adminBtn" onclick="toggleDrawMode()"><i class="fa-solid fa-plus-circle"></i> NOWA STREFA</button>
                </div>
            </div>

            <div style="margin-top: 10px;">
                <div class="search-box">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" placeholder="Szukaj gracza..." id="playerSearch">
                </div>
                
                <p style="font-size: 11px; font-weight: 800; color: var(--text-muted); margin: 15px 0 10px 5px; letter-spacing: 1px;">
                    OZNACZENI (<span id="player-count-num">0</span>)
                </p>

                <div id="player-list-ui" class="player-list-scroll">
                    </div>
            </div>

            <a href="/logout" style="margin-top: auto; text-align: center; font-size: 11px; color: var(--text-muted); text-decoration: none; font-weight: 600; opacity: 0.5;">WYLOGUJ SESJĘ</a>
        </aside>

        <main class="map-outline">
            <div id="map"></div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentUser = null, isDrawMode = false, firstPoint = null, allZones = [], currentActiveMap = 'starfall';
        
        const mapConfigs = {
            'starfall': { 
                url: 'https://cdn.discordapp.com/attachments/1444651629633601669/1460615666422780035/image.png?ex=696a32d7&is=6968e157&hm=bcb83e25ab9e73e362e74158db4135db2dfb3b5780179687af5ae3b0e883f15b&', 
                bounds: [[0, 0], [500, 500]] 
            },
            'venture': { 
                url: 'https://cdn.discordapp.com/attachments/1444651629633601669/1461368359835799623/image.png?ex=696a4cd7&is=6968fb57&hm=2189699ad6534e675e1efdeccf200eaa414485fe773d68c6fa2fc39994dac61c&', 
                bounds: [[0, 0], [500, 500]] 
            }
        };

        const map = L.map('map', { 
            crs: L.CRS.Simple, minZoom: -1, maxZoom: 2, 
            zoomControl: false, attributionControl: false 
        });
        
        let mapOverlay = L.imageOverlay(mapConfigs.starfall.url, mapConfigs.starfall.bounds).addTo(map);
        map.fitBounds(mapConfigs.starfall.bounds);

        async function fetchZones() {
            try {
                const res = await fetch('/api/zones');
                const data = await res.json();
                if (!isDrawMode) { 
                    allZones = data; 
                    renderAllZones(); 
                    updatePlayerList();
                }
            } catch (e) { console.error("Sync error"); }
        }

        async function bootstrap() {
            try {
                const userRes = await fetch('/api/user');
                const userData = await userRes.json();
                if (userData && userData.id) {
                    currentUser = userData;
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('logged-section').style.display = 'block';
                    document.getElementById('u-name').innerText = userData.username;
                    document.getElementById('u-avatar').src = userData.avatar ? `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png` : 'https://via.placeholder.com/60';
                    if (userData.isAdmin) document.getElementById('admin-panel').style.display = 'block';
                }
            } catch (e) {}
            await fetchZones();
            setInterval(fetchZones, 5000);
        }

        function changeMap(mapId) {
            currentActiveMap = mapId;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.id === `btn-${mapId}`));
            mapOverlay.setUrl(mapConfigs[mapId].url);
            renderAllZones();
        }

        function renderAllZones() {
            map.eachLayer(l => { if (l instanceof L.Rectangle || l instanceof L.Tooltip) map.removeLayer(l); });
            
            allZones.filter(z => z.map === currentActiveMap).forEach(zoneData => {
                const count = zoneData.owners.length;
                let col = count === 1 ? "#2ecc71" : (count > 1 ? "#ef4444" : "#ffffff");
                
                const rect = L.rectangle([zoneData.p1, zoneData.p2], { 
                    color: col, weight: 2, fillColor: col, fillOpacity: count > 0 ? 0.4 : 0.05 
                }).addTo(map);

                if (count > 0) {
                    const html = `
                        <div class="avatar-badge-stack" style="border-color:${col}">
                            ${zoneData.owners.map(o => `<img src="${o.avatar}" class="badge-img" title="${o.name}">`).join('')}
                            <span class="badge-count">${count}</span>
                        </div>`;
                    rect.bindTooltip(html, { permanent: true, direction: 'center', className: 'zone-tooltip' }).openTooltip();
                }

                rect.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    if (!isDrawMode && currentUser) handleZoneClick(zoneData);
                });

                // Usuwanie dla Admina (PPM)
                rect.on('contextmenu', (e) => {
                    L.DomEvent.stopPropagation(e);
                    if (currentUser?.isAdmin && confirm("Usunąć tę strefę?")) {
                        allZones = allZones.filter(z => z.id !== zoneData.id);
                        saveZones();
                    }
                });
            });
            
            const totalOnMap = allZones.filter(z => z.map === currentActiveMap).reduce((acc, z) => acc + z.owners.length, 0);
            document.getElementById('count-total').innerText = totalOnMap;
        }

        function updatePlayerList() {
            const listContainer = document.getElementById('player-list-ui');
            const players = [];
            allZones.filter(z => z.map === currentActiveMap).forEach(z => {
                z.owners.forEach(o => { if(!players.find(p => p.name === o.name)) players.push(o); });
            });

            document.getElementById('player-count-num').innerText = players.length;
            listContainer.innerHTML = players.map(p => `
                <div class="player-item">
                    <img src="${p.avatar}" alt="">
                    <span>${p.name}</span>
                </div>
            `).join('');
        }

        async function handleZoneClick(zone) {
            const isInside = zone.owners.some(o => o.name === currentUser.username);
            if (isInside) {
                zone.owners = zone.owners.filter(o => o.name !== currentUser.username);
            } else {
                // Usuwamy z innych stref na TEJ SAMEJ mapie
                allZones.forEach(z => { if(z.map === currentActiveMap) z.owners = z.owners.filter(o => o.name !== currentUser.username); });
                zone.owners.push({ name: currentUser.username, avatar: document.getElementById('u-avatar').src });
            }
            saveZones();
        }

        async function saveZones() {
            renderAllZones();
            updatePlayerList();
            await fetch('/api/zones', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(allZones) 
            });
        }

        function toggleDrawMode() {
            isDrawMode = !isDrawMode;
            document.getElementById('adminBtn').classList.toggle('active');
            document.getElementById('adminBtn').innerHTML = isDrawMode ? '<i class="fa-solid fa-times"></i> ANULUJ' : '<i class="fa-solid fa-plus-circle"></i> NOWA STREFA';
            firstPoint = null;
        }

        map.on('click', (e) => {
            if (!isDrawMode) return;
            if (!firstPoint) {
                firstPoint = e.latlng;
            } else {
                allZones.push({ 
                    id: Date.now(), 
                    map: currentActiveMap, 
                    p1: [firstPoint.lat, firstPoint.lng], 
                    p2: [e.latlng.lat, e.latlng.lng], 
                    owners: [] 
                });
                firstPoint = null;
                toggleDrawMode();
                saveZones();
            }
        });

        bootstrap();
    </script>
</body>
</html>
